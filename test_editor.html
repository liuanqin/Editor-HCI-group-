<!doctype html>
<html lang="en">
<head>
  <title>ND HCI Group -- Code Editor</title>

<script type="text/javascript" src="./caretposition.js"></script>
</head>
<body onload="init()">
<h1>Code Editor</h1>
  <!--  <button id="undo">Undo</button>
    <button id="redo">Redo</button>
    <select id="dropdown">
    <option value="">Size</option>
    <option value="text1">12px</option>
    <option value="text2">18px</option>
    <option value="text3">22px</option>
    <option value="text4">26px</option>
</select>-->
<div id="links">
<input type="button" value="Type"  onclick="reset('board'); up('canvas-text-editor');moveCaretToEnd('myTextArea');document.getElementById('myTextArea').focus(); ">
<input type="button" value="Write" onclick="reset('canvas-text-editor'); up('board');moveCaretToEnd('myTextArea');hideKeyboard;document.getElementById('myTextArea').focus();readonly='true'; ">
<input type="button" value="do" onclick="doRecognition();">
<div id="canvas-text-editor">
  <textarea id="myTextArea" hideKeyboard; atuofocus></textarea>

</div>

<div id="board">

    <br/>
    <canvas id="canvas" ></canvas>
    <br/>
    <pre id="result"><em style="color: white;"></em></pre>

</div>
<script type="text/javascript">

function init()
{
document.getElementById('myTextArea').focus();
hideKeyboard();

};

var hideKeyboard = function() {
 document.activeElement.blur();
 var inputs = document.querySelectorAll('input');
 for(var i=0; i < inputs.length; i++) {
  inputs[i].blur();
 }
};

function moveCaretToEnd(el) {
    if (typeof el.selectionStart == "number") {
        el.selectionStart = el.selectionEnd = el.value.length;
    } else if (typeof el.createTextRange != "undefined") {
        el.focus();
        var range = el.createTextRange();
        range.collapse(false);
        range.select();
    }
}
</script>
<style type="text/css" media="screen">
html, body {
	width: 100%;
	height: 100%;
}
#canvas-text-editor{
    position:absolute; top:18%; left:0; right:0; bottom:0;
    width:100%;
    height: 100%;
    margin:5px 0;
    padding:3px;
    z-index:-1;
    overflow-y: : hidden;
    box-sizing: border-box;         /* For IE and modern versions of Chrome */
  -moz-box-sizing: border-box;    /* For Firefox                          */
  -webkit-box-sizing: border-box;
}
#canvas{
  position:absolute; top:0; left:0; right:0; bottom:0;
  width:100%;
  height: 100%;
  overflow-y: : hidden;
  z-index:1;
  box-sizing: border-box;         /* For IE and modern versions of Chrome */
-moz-box-sizing: border-box;    /* For Firefox                          */
-webkit-box-sizing: border-box;
}
#board{
  position:absolute; top:18%; left:0; right:0; bottom:0;
  width:100%;
  height: 100%;
  overflow-y: : hidden;
  z-index:1;
  box-sizing: border-box;         /* For IE and modern versions of Chrome */
-moz-box-sizing: border-box;    /* For Firefox                          */
-webkit-box-sizing: border-box;
}
textarea
{
  position:absolute; top:0; left:0; right:0; bottom:0;
  border:1px solid #999999;
  width:100%;
  height: 100%;
  margin:5px 0;
  padding:3px;
  overflow-y: : hidden;
  font-family:Times New Roman;
   font-size: 26px;
  box-sizing: border-box;         /* For IE and modern versions of Chrome */
-moz-box-sizing: border-box;    /* For Firefox                          */
-webkit-box-sizing: border-box;
}
</style>

<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js">
$('#myTextArea').on('focus', 'input', function() { $(this).blur(); });

</script>
<script>

function reset(id)
{
    document.getElementById(id).style.zIndex = '0';
}

function up(id)
{
    document.getElementById(id).style.zIndex = '1';
}


        var canvas = document.getElementById('canvas');
        var parent = document.getElementById('board');

        canvas.height = parent.offsetHeight;
        canvas.width = parent.offsetWidth;

      /*  var mytextbox = document.getElementById('myTextArea');
        var mydropdown = document.getElementById('dropdown');

           mydropdown.onchange = function(){
                 mytextbox.fontSize = this.value; //to appened
                //mytextbox.innerHTML = this.value;
           }*/
           setInterval(function () {
           var textArea = document.getElementById("myTextArea");
           var caretPosition = Measurement.caretPos(textArea);
           console.log(caretPosition.left);
           console.log(caretPosition.top);
         },2000);

</script>
</body>
<p id="demo"></p>

<script type="text/javascript" src="MyScript_Cloud-text-JS_Sample/sample/lib/core-min.js"></script>
<script type="text/javascript" src="MyScript_Cloud-text-JS_Sample/sample/lib/x64-core-min.js"></script>
<script type="text/javascript" src="MyScript_Cloud-text-JS_Sample/sample/lib/sha512-min.js"></script>
<script type="text/javascript" src="MyScript_Cloud-text-JS_Sample/sample/lib/hmac-min.js"></script>
<script type="text/javascript" src="MyScript_Cloud-text-JS_Sample/sample/lib/q.js"></script>
<script type="text/javascript" src="MyScript_Cloud-text-JS_Sample/sample/lib/hand.minified-1.3.8.js"></script>
<script type="text/javascript" src="MyScript_Cloud-text-JS_Sample/myscript.min.js"></script>
<script type="text/javascript" src="./caretposition.js"></script>

<script>
    (function () {
        var result = document.getElementById('result');
        var canvas = document.getElementById('canvas');
        //var trash = document.getElementById('trash');
        //var undo = document.getElementById('undo');
        //var redo = document.getElementById('redo');
        //var languages = document.getElementById('languages');
        var context = canvas.getContext('2d');
        var pointerId;

        var applicationKey =  "1b96efa9-7fc3-4bf2-8881-db20c37b556e";
        var hmacKey =  "c504e889-4716-436c-8bd9-e4af59f546ef";

        var inkManager = new MyScript.InkManager();
        var textRenderer = new MyScript.TextRenderer();
        var textRecognizer = new MyScript.TextRecognizer();
        var instanceId;

        //div = document.getElementById("divGameStage");
        //div.appendChild(canvas);

        var lastFocused;
        $("#myTextArea").focus(function() {
          lastFocused = document.activeElement;
        });

        //http://stackoverflow.com/questions/1064089/inserting-a-text-where-cursor-is-using-javascript-jquery
        function insertText(text) {
          var input = lastFocused;
          console.log(input);
          if (input == undefined) { return; }
          var scrollPos = input.scrollTop;
          var pos = 0;
          var browser = ((input.selectionStart || input.selectionStart == "0") ?
            "ff" : (document.selection ? "ie" : false ) );
          if (browser == "ie") {
            input.focus();
            var range = document.selection.createRange();
            range.moveStart ("character", -input.value.length);
            pos = range.text.length;
          }
          else if (browser == "ff") { pos = input.selectionStart };

          var front = (input.value).substring(0, pos);
          var back = (input.value).substring(pos, input.value.length);
          input.value = front+text+back;
          pos = pos + text.length;
          if (browser == "ie") {
            input.focus();
            var range = document.selection.createRange();
            range.moveStart ("character", -input.value.length);
            range.moveStart ("character", pos);
            range.moveEnd ("character", 0);
            range.select();
          }
          else if (browser == "ff") {
            input.selectionStart = pos;
            input.selectionEnd = pos;
            input.focus();
          }
          input.scrollTop = scrollPos;
        }


        // insert text at the cursor
        function insertAtCursor(myField, myValue) {
            //IE support
            if (document.selection) {
                myField.focus();
                sel = document.selection.createRange();
                sel.text = myValue;
            }
            //MOZILLA and others
            else if (myField.selectionStart || myField.selectionStart == '0') {
                var startPos = myField.selectionStart;
                var endPos = myField.selectionEnd;
                myField.value = myField.value.substring(0, startPos)
                    + myValue
                    + myField.value.substring(endPos, myField.value.length);
                    console.log(startPos + " is start");
                    console.log(endPos + " is end");


            } else {
                myField.value += myValue;
            }
        }

        function doRecognition() {

            if (inkManager.isEmpty()) {
                result.innerHTML = '';
            } else {

                var inputUnit = new MyScript.TextInputUnit();
                inputUnit.setComponents(inkManager.getStrokes());

                var units = [inputUnit];

                textRecognizer.doSimpleRecognition(applicationKey, instanceId, units, hmacKey).then(
                        function (data) {
                            if (!instanceId) {
                                instanceId = data.getInstanceId();
                            } else if (instanceId !== data.getInstanceId()) {
                                return;
                            }
                            result.innerHTML = data.getTextDocument().getTextSegmentResult().getSelectedCandidate().getLabel()+" ";



                            //insertAtCursor(myTextArea, result.innerHTML);
                            insertText(result.innerHTML);
                            //console.log(result.innerHTML);
                            //console.log(myTextArea.value);

                            instanceId = undefined;
                            textRenderer.clear(context);
                            inkManager.clear();
                            result.innerHTML = '';
                            //insertAtCaret('editor',result.innerHTML);
                            hideKeyboard();


                        }
                );
            }
        }


        canvas.addEventListener('pointerdown', function (event) {
            if (!pointerId) {
                pointerId = event.pointerId;
                event.preventDefault();

                textRenderer.drawStart(event.offsetX, event.offsetY);
                inkManager.startInkCapture(event.offsetX, event.offsetY);
            }
        }, false);

        canvas.addEventListener('pointermove', function (event) {
            if (pointerId === event.pointerId) {
                event.preventDefault();

                textRenderer.drawContinue(event.offsetX, event.offsetY, context);
                inkManager.continueInkCapture(event.offsetX, event.offsetY);
            }
        }, false);

        var timer = (new Date()).getTime();
        canvas.addEventListener('pointerup', function (event) {
            if (pointerId === event.pointerId) {

                event.preventDefault();

                textRenderer.drawEnd(event.offsetX, event.offsetY, context);
                inkManager.endInkCapture();
                timer = (new Date()).getTime();                //onClickCheck();
                //setTimeout(function() {
                  //console.log(result.innerHTML);
              /* setTimeout(function (){
               while (pointerId == undefined) {
                   // point up function again
                   break;
           }
         },200);*/

           pointerId = undefined;
          //doRecognition();
   }
        }, false);


        canvas.addEventListener('pointerleave', function (event) {
            if (pointerId === event.pointerId) {
                event.preventDefault();

                textRenderer.drawEnd(event.offsetX, event.offsetY, context);
                inkManager.endInkCapture();
                pointerId = undefined;
                doRecognition();

              //  setTimeout(function() {
                  //console.log(result.innerHTML);
                //  doRecognition();
            //    }, 2000);
            }
        }, false);
/*
        var lastClicked = (new Date()).getTime();

        canvas.pointerupEvent = function() {
          lastClicked = (new Date()).getTime();
          console.log("aa");

};*/

function onClickCheck() {
    var timeNow = (new Date()).getTime();
    if (timeNow > (timer + 800)) {

        //console.log(timeNow - timer -1000);
      doRecognition();
    }

       //timer = (new Date()).getTime();
}


//window.setInterval(onClickCheck(),1000);

var myVar = setInterval(function(){ onClickCheck() }, 500);





      /*  trash.addEventListener('click', function trash() {
            instanceId = undefined;
            textRenderer.clear(context);
            inkManager.clear();
            result.innerHTML = '';
        }, false);

       undo.addEventListener('click', function () {
            if (!inkManager.isEmpty()) {
                inkManager.undo();
                textRenderer.clear(context);
                textRenderer.drawStrokes(inkManager.getStrokes(), context);
            }
            doRecognition();
        }, false);

        redo.addEventListener('click', function () {
            if (!inkManager.isRedoEmpty()) {
                inkManager.redo();
                textRenderer.clear(context);
                textRenderer.drawStrokes(inkManager.getStrokes(), context);
            }
            doRecognition();
        }, false);*/



    })();
</script>
</html>
